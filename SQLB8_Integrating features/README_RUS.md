## _Let's improve customer experience_

В этом проекте ты научишься реализовывать бизнес-требования, обеспечивать целостность данных через ограничения и индексы, оптимизировать производительность БД, работать с последовательностями и массовыми операциями, а также документировать структуру базы — навыки необходимые, если ты backend-разработчик, дата-инженер или аналитик и работаешь с production-средами и системами лояльности в реальных компаниях.

Убедись, что все изменения, которые были внесены в проект SQLB4_DML (Day 03) в ходе Заданий 07-13, и в проект SQLB5_Snapshots (Day 04) Задание 07, должны сохраняться (это похоже на реальную ситуацию, когда после выпуска релиза требуется обеспечить согласованность данных для новых изменений).

## Задание 00 — Discounts, discounts, everyone loves discounts

Тебе нужно добавить новую бизнес-возможность в модель данных. Каждый клиент хочет видеть персональную скидку, а каждый бизнес стремится быть ближе к своим покупателям.

Представь систему персональных скидок для клиентов с одной стороны и пиццерий — с другой. Тебе нужно создать новую таблицу отношений (задай ей имя person_discounts) со следующими правилами:

- Определи атрибут id в качестве Primary Key (посмотри на столбец id в существующих таблицах и выбери тот же тип данных).
- Определи атрибуты person_id и pizzeria_id как Foreign Keys для соответствующих таблиц (типы данных должны совпадать с типами столбцов id в соответствующих родительских таблицах).
- Задай явные имена для ограничений внешнего ключа, используя шаблон fk_{table_name}_{column_name}, например, fk_person_discounts_person_id.
- Добавь атрибут discount для хранения значения скидки в процентах. Учти, что значение скидки может быть числом с плавающей запятой (используй тип данных numeric). Поэтому выбери соответствующий тип данных, чтобы учесть эту возможность.

## Задание 01 — Let's set personal discounts

Итак, у тебя есть структура для хранения скидок и можно двигаться дальше — заполнить таблицу person_discounts новыми записями.

Перед тобой таблица person_order, в которой хранится история заказов клиентов. Тебе нужно написать DML-оператор (INSERT INTO ... SELECT ...), который заполнит таблицу person_discounts новыми записями, следуя приведенным правилам:

- Сгруппируй данные по столбцам person_id и pizzeria_id.
- Рассчитай размер персональной скидки по следующему псевдокоду:
  - Если количество заказов = 1, то скидка = 10.5
  - Иначе если количество заказов = 2, то скидка = 22
  - Иначе скидка = 30
- Чтобы создать первичный ключ для таблицы person_discounts, используй следующую SQL-конструкцию (эта конструкция относится к разделу SQL о оконных функциях):
  ROW_NUMBER() OVER () AS id

## Задание 02 — Let's recalculate a history of orders

Напиши SQL-запрос, который возвращает список заказов с фактической стоимостью и стоимостью с примененной скидкой для каждого клиента в соответствующей пиццерии. Отсортируй результаты по имени клиента и названию пиццы.

Пример вывода данных приведен ниже.

| name | pizza_name | price | discount_price | pizzeria_name |
|------|------------|-------|----------------|---------------|
| Andrey | cheese pizza | 800 | 624 | Dominos |
| Andrey | mushroom pizza | 1100 | 858 | Dominos |
| ... | ... | ... | ... | ... |

## Задание 03 — Improvements are in a way

Тебе необходимо обеспечить улучшение согласованности данных с одной стороны и повышение производительности — с другой.

Создай уникальный многоколоночный индекс (с именем idx_person_discounts_unique), который предотвратит дублирование пар идентификаторов person_id и pizzeria_id.

После создания нового индекса, предоставь любое простое SQL-выражение, которое демонстрирует использование индекса (с помощью EXPLAIN ANALYZE). Пример подтверждения приведён ниже:

    ...
    Index Scan using idx_person_discounts_unique on person_discounts
    ...

## Задание 04 — We need more Data Consistency

Добавь следующие правила ограничений (constraints) для существующих столбцов таблицы person_discounts:

1. Столбец person_id не должен содержать NULL (используй имя ограничения ch_nn_person_id).
2. Столбец pizzeria_id не должен содержать NULL (используй имя ограничения ch_nn_pizzeria_id).
3. Столбец discount не должен содержать NULL (используй имя ограничения ch_nn_discount).
4. Столбец discount должен иметь значение по умолчанию 0 (0%).
5. Столбец discount должен содержать значения в диапазоне от 0 до 100 (используй имя ограничения ch_range_discount).

## Задание 05 — Data Governance Rules

В соответствии с политикой управления данными (Data Governance Policies), необходимо добавить комментарии к таблице и ее столбцам.

Примени это требование к таблице person_discounts. Добавь комментарии на английском или русском языке (на твое усмотрение), объясняющие бизнес-назначение таблицы и всех ее атрибутов.

## Задание 06 — Let's automate Primary Key generation

| **Запрещено** | |
| Шаблон SQL-синтаксиса | Не используй жёстко заданные значения (hard-coded) для количества строк, чтобы установить правильное значение для последовательности. |

Необходимо создать последовательность базы данных с именем seq_person_discounts (начиная со значения 1) и установить значение по умолчанию для атрибута id таблицы person_discounts, чтобы оно автоматически бралось из seq_person_discounts при каждой вставке.

Обрати внимание: следующее значение последовательности должно быть равно 1. В этом случае тебе нужно установить актуальное значение для последовательности на основе формулы: "количество строк в таблице person_discounts" + 1. В противном случае ты получишь ошибки нарушения ограничения первичного ключа (Primary Key violation constraint).